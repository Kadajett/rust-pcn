apiVersion: v1
kind: Pod
metadata:
  name: pcn-train-baseline
  namespace: pcn-train
  labels:
    app: pcn-train
    variant: baseline
spec:
  runtimeClassName: nvidia
  restartPolicy: Never
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - theshire
  containers:
  - name: pcn-train
    image: ubuntu:24.04
    command: ["/bin/bash", "-c"]
    args:
    - |
      echo "=== PCN Training: BASELINE (no SEAL) ==="
      echo "Starting at $(date)"
      echo ""
      echo "GPU check:"
      nvidia-smi || echo "No nvidia-smi"
      echo ""
      echo "Running training..."
      cd /workspace
      exec ./target/release/pcn-train \
        --books-dir data/books \
        --checkpoint-dir data/checkpoints/baseline \
        --metrics-file data/output/metrics-baseline.jsonl \
        --gpu \
        --epochs 20 \
        --max-samples-per-book 10000 \
        --batch-size 512 \
        --books-per-round 1 \
        --eval-every 5
    env:
    - name: TZ
      value: America/New_York
    - name: NVIDIA_DRIVER_CAPABILITIES
      value: compute,utility
    - name: NVIDIA_VISIBLE_DEVICES
      value: all
    - name: CUDA_VISIBLE_DEVICES
      value: "0"
    - name: RUST_BACKTRACE
      value: "1"
    - name: LD_LIBRARY_PATH
      value: /usr/local/cuda-13.0/targets/x86_64-linux/lib:/usr/local/cuda/lib64:/usr/local/cuda/targets/x86_64-linux/lib
    resources:
      requests:
        cpu: "2"
        memory: 2Gi
      limits:
        cpu: "4"
        memory: 16Gi
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: cuda-13-0
      mountPath: /usr/local/cuda-13.0
      readOnly: true
    - name: cuda-13-1
      mountPath: /usr/local/cuda
      readOnly: true
    workingDir: /workspace
  volumes:
  - name: workspace
    hostPath:
      path: /home/kadajett/dev/rust-pcn
      type: Directory
  - name: cuda-13-0
    hostPath:
      path: /usr/local/cuda-13.0
      type: Directory
  - name: cuda-13-1
    hostPath:
      path: /usr/local/cuda-13.1
      type: Directory
